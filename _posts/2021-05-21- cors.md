---
layout: post
title: API Gateway API에서 CORS 오류 해결하기.
date:   2021-05-22 10:00:35 +0300
image: pexels-scott-webb-1029613.jpg
---
![CORS](https://files.slack.com/files-pri/T01CGBWU0EB-F021WRFGVM5/1621396241366.png)]
![CORS--img--](https://files.slack.com/files-pri/T01CGBWU0EB-F022BQZ6T6F/1621396240491.png)]


## Same-Origin Policy 란? 


자바스크립트 엔진 표준 스펙의 보안 규칙 중 하나입니다. 자바스크립트는 자신이 속한 동일한 출처의 페이지에만 서버 요청을 허용하고 처리해 주며, 다른 출처의 서버에 요청하는 것을 보안 문제로 간주하고 차단합니다. 여기서 동일한 출처(same origin)란 같은 프로토콜, 같은 호스트, 같은 포트를 사용한다는 것입니다. 제가 이해하기로는 응답에서 에러가 나는게 아니라 아예 요청 자체가 거부당합니다.


# Q. API 서버를 따로 만들고 싶을 땐, 어떻게 해야 할까요?


## 1. CORS (Cross-Origin Resource Sharing)

교차 출처 리소스 공유 또는 CORS는 최신 웹 브라우저의 보안 기능입니다. 이를 통해 웹 브라우저는 외부 웹 사이트 또는 서비스를 요청할 수있는 도메인을 협상 할 수 있습니다. CORS는 JavaScript 용 AWS SDK를 사용하여 브라우저 애플리케이션을 개발할 때 중요한 고려 사항입니다. 리소스에 대한 대부분의 요청은 웹 서비스의 엔드 포인트와 같은 외부 도메인으로 전송되기 때문입니다. JavaScript 환경에서 CORS 보안을 적용하는 경우 서비스를 사용하여 CORS를 구성해야합니다.

CORS는 다음을 기반으로 교차 출처 요청에서 리소스 공유를 허용할지 여부를 결정합니다.


별도의 API 서버를 만들고 싶어서 이 Cross-domain 문제를 피하고자 한다면, 그 방법은 CORS를 설정해주는 것입니다. CORS는 MDN 용어사전에 의하면, ‘다른 도메인(domains)에서의 자원을 호출하는 행위에 제한이 없을 경우 안전하지 않습니다. CORS (Cross-Origin Resource Sharing)는 이렇게 시스템 수준에서 타 도메인 간 자원 호출을 승인하거나 차단하는 것을 결정하는 것입니다.’ 라고 합니다.(번역된 문장이라 더 어렵게 느껴집니다.) 여기서 CORS는 서로 다른 도메인 간에 리소스를 주고 받는 것을 허용해주거나 차단하는 설정입니다.

찾아보니 서버 설정 없이 클라이언트 쪽에서도 Cross-domain 문제를 해결할 수도 있다고 합니다. 하지만 그 기능이 제한적이고, 서버 쪽에서 해결하는 것이 정석이라고 하니 정석대로 하는것이 가장 최선의 확실한 방법일 듯 합니다.

+ 요청을하는 특정 도메인

+ HTTP 요청 유형 (GET, PUT, POST, DELETE 등)

## 2. CORS의 작동 원리
![How--CORS--Works](https://docs.aws.amazon.com/sdk-for-javascript/v2/developer-guide/images/cors-overview.png)]
다른 도메인의 리소스를 요청했을때, 위와 같은 과정으로 진행이 됩니다. 브라우저에서 실제 요청을 하기 전 사전요청을 보내서 CORS가 허용이 되어 있는지 확인 후에, 실제 요청을 보내서 응답을 받아온다. CORS 설정이 안되어있다면 아예 사전 요청에서 막힙니다

요청 도메인 또는 HTTP 요청 유형이 승인되지 않은 경우 요청이 거부됩니다. 그러나 CORS를 사용하면 실제로 요청을 제출하기 전에 요청을 프리 플라이트 할 수 있습니다. 이 경우 OPTIONS 액세스 요청 작업이 전송 되는 프리 플라이트 요청이 만들어 집니다. 교차 원본 서버의 CORS 구성이 요청 도메인에 대한 액세스 권한을 부여하면 서버는 요청 도메인이 요청 된 리소스에 대해 만들 수있는 모든 HTTP 요청 유형을 나열하는 프리 플라이트 응답을 다시 보냅니다.

## 3. CORS 구성
Amazon S3 버킷에서 작업을 수행하려면 먼저 CORS 구성이 필요합니다. 일부 JavaScript 환경에서는 CORS가 적용되지 않을 수 있으므로 CORS를 구성 할 필요가 없습니다. 예를 들어 Amazon S3 버킷에서 애플리케이션을 호스팅하고 다음에서 리소스에 액세스하는 경우*.s3.amazonaws.com 또는 다른 특정 엔드 포인트의 경우 요청이 외부 도메인에 액세스하지 않습니다. 따라서이 구성에는 CORS가 필요하지 않습니다. 이 경우 CORS는 Amazon S3 이외의 서비스에 계속 사용됩니다.




## 4. API Gateway API에서 CORS 오류 해결하기.


### 1) FLASK-CORS
사실 그냥 이론만 보고, 번역된 문장만 읽는다면 굉장히 어렵고 복잡해보이는 작업들이 기다리고 있을 것 같지만 실제로는 그렇지 않습니다. 
 

터미널을 열고 가상환경에 들어와서 아래와 같이 입력합니다.

이미 가상환경이 생성되어있고, 격리된 가상환경 속에 들어와서 작업을 하는 것을 기준으로 합니다.

```

(.ve)$ pip install flask-cors

```

 

flask-cors 모듈 설치 후, 아래와 같이 코드를 추가합니다.

```
from flask import Flask
from flask_cors import CORS

app = Flask(__name__)
cors = CORS(app, resources={
  r"/v1/*": {"origin": "*"},
  r"/api/*": {"origin": "*"},
})

```

저는 아래와 같이 코드를 입력하여 CORSF를 해결 하였습니다.

```
from checkPage import checkPage
from flask import Flask, request
from flask_restx import Api, Resource
from flask_cors import CORS, cross_origin

TARGET_WORDS = [
    "바카라",
    "카지노",
    "파워볼",
    "사다리",
    "슬롯",
    "카지노",
    "홀짝",
    "블랙잭",
    "홀덤",
    "이용약관",
]


app = Flask("checkPageAPI")
CORS(app)
api = Api(app)


@api.route("/check/<string:url1>/<string:url2>")
class main(Resource):
    def get(self, url1, url2):
        url = f"{url1}/{url2}"
        data = checkPage(url, TARGET_WORDS)
        return data
```


이렇게 코드를 쓰고 나면 완료됩니다. 
그러면 “/v1/“으로 시작되거나, “/api/“로 시작되는 요청을 사용할 수 있습니다.
 다른 도메인에서 요청을 했을때 정상적으로 요청이 들어가고 응답을 받을 수 있습니다.